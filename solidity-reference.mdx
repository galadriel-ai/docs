This page describes the details of the Solidity interface to the oracle, and how to use it in your contract. We assume you are familiar with the [high-level architecture of Galadriel](/how-it-works).

# Oracle interface

The oracle is exposed as a contract that you can call from your own contract. It exposes two types of functionality: calling **LLMs** and calling **external tools**.

The relevant parts of the oracle contract that you can call consist of two parts:

* Methods you call on the oracle: see [Methods you can call on the oracle](#oracle-contract-methods).
* Callback methods you implement on your contract: see [Callback methods](#callback-methods).

See the [Usage](#usage) section below on how to integrate depending on your use case.

## Oracle contract methods

See source code for all the methods in the [`ChatOracle` contract](https://github.com/galadriel-ai/contracts/blob/main/contracts/contracts/ChatOracle.sol#L90C14-L90C27).

### createLlmCall

This is a simplified function that method makes a call to OpenAI GPT-4 with default parameters and provides no configurability. If you want to use other models, or configure other parameters like `temperature`, see [createOpenAiLlmCall](#createopenaillmcall).

Arguments
* `uint promptCallbackId` - identifier which will be passed into the callback.

Returns:
* `uint` - an internal counter of the oracle, which is incremented on every call.

### createOpenAiLlmCall

This is a function that calls an OpenAI LLM. You can configure almost any parameter that can be configured in the [Create chat completion](https://platform.openai.com/docs/api-reference/chat/create) OpenAI endpoint.

Arguments
* `uint promptCallbackId` - identifier which will be passed into the callback.
* `OpenAiRequest config` - an object that contains all configuration parameters for the LLM call; see [below](#openairequest-object).

Returns:
* `uint` - an internal counter of the oracle, which is incremented on every call.


#### OpenAiRequest object

The `OpenAiRequest` object (see source in [ChatOracle.sol](https://github.com/galadriel-ai/contracts/blob/main/contracts/contracts/ChatOracle.sol)) has the following fields:

* `string model` - the identifier for the model, either `gpt-4-turbo-preview` or `gpt-3.5-turbo-1106`.
* `int8 frequencyPenalty` - an integer between -20 and 20, mapped to a float between -2.0 and 2.0; values greater than 20 are treated as null. TODO
* `string logitBias` - a JSON string representing logit bias or an empty string if none.
* `uint32 maxTokens` - the maximum number of tokens to generate, with 0 indicating null.
* `int8 presencePenalty` - an integer between -20 and 20, mapped to a float between -2.0 and 2.0; values greater than 20 are treated as null.
* `string responseFormat` - a JSON string specifying the format of the response or an empty string if default.
* `uint seed` - a seed for the random number generator, with 0 indicating null.
* `string stop` - a string specifying stop sequences, or an empty string to indicate null.
* `uint temperature` - a temperature setting for randomness, with values from 0 to 20; values greater than 20 indicate null.
* `uint topP` - controls diversity via nucleus sampling, with values from 0 to 100 percent; values greater than 100 indicate null.
* `string tools` - a JSON list of tools in OpenAI format, or an empty string for null, where names must match supported tools.
* `string toolChoice` - specifies tool selection strategy, with values "none", "auto", or an empty string which defaults to "auto" on OpenAI's side.
* `string user` - identifier for the user making the request.


### createGroqLlmCall

This is a function that calls an open-source LLM hosted by [Groq](https://groq.com/). You can configure almost any parameter that can be configured in the [Create chat completion](https://console.groq.com/docs/text-chat) Groq endpoint.

Arguments
* `uint promptCallbackId` - identifier which will be passed into the callback.
* `GroqRequest config` - an object that contains all configuration parameters for the LLM call; see [below](#groqrequest-object).

Returns:
* `uint` - an internal counter of the oracle, which is incremented on every call.


#### GroqRequest object

The `GroqRequest` object (see source in [ChatOracle.sol](https://github.com/galadriel-ai/contracts/blob/main/contracts/contracts/ChatOracle.sol)) has the following fields:

* `string model` - the model to be used, options are `llama2-70b-4096`, `mixtral-8x7b-32768`, or `gemma-7b-it`. See [Groq docs](https://console.groq.com/docs/models) for more info on the models.
* `int8 frequencyPenalty` - penalty for frequency, int -20 to 20, mapped to float -2.0 to 2.0. Values greater than 20 result in null.
* `string logitBias` - JSON string specifying logit bias, or an empty string for none.
* `uint32 maxTokens` - maximum number of tokens to generate, with 0 indicating null.
* `int8 presencePenalty` - penalty for presence, int -20 to 20, mapped to float -2.0 to 2.0. Values greater than 20 result in null.
* `string responseFormat` - JSON string indicating the format of the response, or an empty string for default format.
* `uint seed` - seed for random number generation, with 0 indicating null.
* `string stop` - stop sequence(s) for generation, or an empty string to indicate none.
* `uint temperature` - temperature for generation, 0 to 20, with values greater than 20 indicating null.
* `uint topP` - top p sampling parameter, 0 to 100 percentage, with values greater than 100 indicating null.
* `string user` - user identifier or context.


### createFunctionCall

This method makes a call to a tool -- see options below. For every tool the input and output are of string type, and you choose a tool by specifying the `functionType` parameter.

Arguments
* `uint functionCallbackId` - identifier which will be passed into the callback.
* `string functionType` - specifies which function to call. Must be one of: `image_generation`, `web_search`.
* `string functionInput` - input to the function.

Returns
* `uint` - an internal counter of the oracle, which is incremented on every call.

The currently available tools are:

<AccordionGroup>
<Accordion title="Image generation">

* `functionType`: `image_generation`
* Functionality: given an input prompt, run [DALL-E 3](https://openai.com/dall-e-3) to generate an image.
* Input: a string with the prompt that is directly given as input to DALL-E.
* Output: a string with the URL of the generated image.

</Accordion>
<Accordion title="Web search">

* `functionType`: `web_search`
* Functionality: given a query string, run a Google search and return the list of results.
* Input: a string with the search query.
* Output: a string with a list of search results in JSON format.

</Accordion>
</AccordionGroup>

## Callback methods

These are callbacks the oracle will call once the response is available, and are described in the [`IChatGpt` interface](https://github.com/galadriel-ai/contracts/blob/main/contracts/contracts/ChatOracle.sol#L7-L28).

### onOracleLlmResponse

Called when the result of an LLM call, created with [`createLlmCall`](#createllmcall), is available.

Arguments
* `uint callbackId` - the identifier you passed into the `createLlmCall` method.
* `string response` - the result of the LLM call.
* `string errorMessage` - an error message. Contains an empty string if there was no error, and a description of the error otherwise.

### onOracleOpenAiLlmResponse

Called when the result of an LLM call, created with [`createOpenAiLlmCall`](#createopenaillmcall), is available.

Arguments
* `uint callbackId` - the identifier you passed into the `createOpenAiLlmCall` method.
* `OpenAiResponse response` - the result of the LLM call; see [below](#openairesponse-object).
* `string errorMessage` - an error message. Contains an empty string if there was no error, and a description of the error otherwise.

#### OpenAiResponse object

The `OpenAiResponse` object (see source in [ChatOracle.sol](https://github.com/galadriel-ai/contracts/blob/main/contracts/contracts/ChatOracle.sol)) has the following fields, most of which map directly to the fields in the [OpenAI API response](https://platform.openai.com/docs/api-reference/chat/object):

* `string id` - unique identifier for the completion, generated by OpenAI.
* `string content` - the model output, either an empty string or combined with `functionName` and `functionArguments`. TODO-Kristjan what format if function?
* `string functionName` - name of the function invoked, if any.
* `string functionArguments` - arguments passed to the function, if any.
* `uint64 created` - timestamp of creation.
* `string model` - the model name used for generation.
* `string systemFingerprint` - identifier for the system generating the completion.
* `string object` - type of the object, always `chat.completion`.
* `uint32 completionTokens` - number of tokens generated in the completion.
* `uint32 promptTokens` - number of tokens in the prompt.
* `uint32 totalTokens` - total number of tokens, including both prompt and completion.



### onOracleGroqLlmResponse

Called when the result of an LLM call, created with [`createGroqLlmCall`](#creategroqllmcall), is available.

Arguments
* `uint callbackId` - the identifier you passed into the `createGroqLlmCall` method.
* `GroqResponse response` - the result of the LLM call; see [below](#groqresponse-object).
* `string errorMessage` - an error message. Contains an empty string if there was no error, and a description of the error otherwise.

#### GroqResponse object

The `GroqResponse` object (see source in [ChatOracle.sol](https://github.com/galadriel-ai/contracts/blob/main/contracts/contracts/ChatOracle.sol)) has the following fields, most of which map directly to the fields in the [Groq API response](https://console.groq.com/docs/text-chat):

* `string id` - unique identifier for the completion, generated by Groq.
* `string content` - the content associated with the completion.
* `uint64 created` - timestamp of creation.
* `string model` - the model name used for the completion.
* `string systemFingerprint` - system identifier that generated the completion.
* `string object` - type of the object, always `chat.completion`.
* `uint32 completionTokens` - number of tokens in the completion.
* `uint32 promptTokens` - number of tokens in the prompt.
* `uint32 totalTokens` - total number of tokens, sum of prompt and completion tokens.


### onOracleFunctionResponse
Called when the result of a tool call, created with [`createFunctionCall`](#createfunctioncall), is available.

Arguments
* `uint callbackId` - the identifier you passed into the `createFunctionCall` method.
* `string response` - the result of the tool call.
* `string errorMessage` - an error message. Contains an empty string if there was no error, and a description of the error otherwise.


### getMessageHistoryContents and getMessageHistoryRoles

These two methods in combination are used to provide the oracle with the message history necessary for the LLM call. They are called by the oracle after [`createLlmcall`](#createllmcall).

The methods should each return a list, one with message contents and the other listing the roles of the message authors. The list lengths should be equal for a given `callbackId`.

For example, if the message history is the following:


role      |        content              |
----------|-----------------------------|
system    | You are a helpful assistant |
user      | Hello!                      |
assistant | Hi! How can I help?         |
user      | How big is the Sun?         |


Then `getMessageHistoryContents` should return the following list of 4 items:
```solidity
["You are a helpful assistant", "Hello!", "Hi! How can I help?", "How big is the Sun?"]
```

...and `getMessageHistoryRoles` should return the following list of 4 items:
```solidity
["system", "user", "assistant", "user"]
```

The signatures of these methods should be:

**getMessageHistoryRoles**

Arguments:
* `uint callbackId` - the identifier you passed into the `createLlmCall` method.

Returns:
* `string[]` - a list of roles.

**getMessageHistoryContents**

Arguments:
* `uint callbackId` - the identifier you passed into the `createLlmCall` method.

Returns:
* `string[]` - a list of message contents.



# Usage

## Calling an LLM

For calling an LLM, one option is to use the [createLlmCall](#createllmcall) method, which has a simple interface but little configurability. The other option is to use the more complex but more powerful [createOpenAiLlmCall](#createopenaillmcall) method -- to make a call to OpenAI-provided LLMs -- or the [createGroqLlmCall](#creategroqllmcall) method -- to make a call to Groq-provided LLMs.


Using the [createLlmCall](#createllmcall) example: to call an LLM you need to:

<Steps>
    <Step>
    Call the [createLlmCall](#createllmcall) method on the oracle contract. This will create a new LLM call.
    </Step>
    <Step>
    Implement two methods into your contract that the oracle will call to get the message history necessary for the LLM, including the system prompt: [getMessageHistoryContents and getMessageHistoryRoles](#getmessagehistorycontents-and-getmessagehistoryroles).
    </Step>
    <Step>
    Implement the [onOracleLlmResponse](#onoraclellmresponse) method into your contract. This method will be called when the LLM result is available (in a separate transaction potentially tens of seconds later).
    </Step>
</Steps>

Using the other two methods is analogous, but you need to use the corresponding callback method:

* `createLlmCall` -> implement callback `onOracleLlmResponse`
* `createOpenAiLlmCall` -> implement callback `onOracleOpenAiLlmResponse`
* `createGroqLlmCall` -> implement callback `onOracleGroqLlmResponse`

## Calling an external tool

If you are calling an external tool, you need to:

<Steps>
    <Step>
    Call the [createFunctionCall](#createfunctioncall) method on the oracle contract. This will create a new tool call.
    </Step>
    <Step>
    Implement the [onOracleFunctionResponse](#onoraclefunctionresponse) method into your contract. This method will be called when the tool result is available (in a separate transaction potentially tens of seconds later).

    Since method calls do not reference a message history, you don't need to implement any history getter methods.
    </Step>
</Steps>

## Examples

Please refer to the [example contracts](https://github.com/galadriel-ai/contracts/tree/main/contracts/contracts), corresponding to the outlined [use cases](/use-cases), for complete usage examples.
